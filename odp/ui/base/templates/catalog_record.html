{% extends 'base.html' %}
{% from 'macros.html' import render_info %}

{% set datacite_metadata = record | select_datacite_metadata %}
{% set iso19115_metadata = record | select_iso19115_metadata %}

{% block web_title %}
    {{ super() }} |
    {% block heading %}
        {{ datacite_metadata.titles[0].title }}
    {% endblock %}
{% endblock %}

{% block main %}
    <main class="flex-grow-1 m-4">
        <ul class="nav nav-tabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#info" type="button" role="tab">
                    Digital Object Record
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" data-bs-toggle="tab" data-bs-target="#datacite-metadata" type="button" role="tab">
                    DataCite Metadata
                </button>
            </li>
            {% if iso19115_metadata %}
                <li class="nav-item" role="presentation">
                    <button class="nav-link" data-bs-toggle="tab" data-bs-target="#iso19115-metadata" type="button" role="tab">
                        ISO19115 Metadata
                    </button>
                </li>
            {% endif %}
        </ul>
        <div class="tab-content">
            <div id="info" class="tab-pane fade show active" role="tabpanel">
                {% call(prop) render_info(record,
                    'DOI',
                    'Title',
                    'Authors',
                    'Contributors',
                    'Publisher',
                    'Abstract',
                    'Methods',
                    'Spatial coverage',
                    'Temporal coverage',
                    'Keywords',
                    'License',
                ) %}
                    {% if prop == 'DOI' %}
                        {{ record.doi if record.doi }}
                    {% elif prop == 'Title' %}
                        {{ datacite_metadata.titles[0].title }}
                    {% elif prop == 'Authors' %}
                        {% for creator in datacite_metadata.creators %}
                            <p>{{ creator.name }}<br/>
                                <small>{{ creator.affiliation | map(attribute='affiliation') | join('<br/>') }}</small>
                            </p>
                        {% endfor %}
                    {% elif prop == 'Contributors' %}
                        {% for contributor in datacite_metadata.contributors %}
                            <p>{{ contributor.name }} ({{ contributor.contributorType }})<br/>
                                <small>{{ contributor.affiliation | map(attribute='affiliation') | join('<br/>') }}</small>
                            </p>
                        {% endfor %}
                    {% elif prop == 'Publisher' %}
                        {{ datacite_metadata.publisher }} ({{ datacite_metadata.publicationYear }})
                    {% elif prop == 'Abstract' %}
                        {{ datacite_metadata.descriptions | selectattr('descriptionType', '==', 'Abstract') | map(attribute='description') | first }}
                    {% elif prop == 'Methods' %}
                        {{ datacite_metadata.descriptions | selectattr('descriptionType', '==', 'Methods') | map(attribute='description') | first }}
                    {% elif prop == 'Spatial coverage' %}

                    {% elif prop == 'Temporal coverage' %}
                        {% if record.temporal_start %}
                            {{ record.temporal_start | date }}
                            {% if record.temporal_end %}
                                &ndash; {{ record.temporal_end | date }}
                            {% endif %}
                        {% endif %}
                    {% elif prop == 'Keywords' %}
                        {{ datacite_metadata.subjects | map(attribute='subject') | join(', ') }}
                    {% elif prop == 'License' %}

                    {% endif %}
                {% endcall %}
            </div>
            <div id="datacite-metadata" class="tab-pane fade" role="tabpanel">
                <pre class="m-3">
                    {{- datacite_metadata|format_json -}}
                </pre>
            </div>
            {% if iso19115_metadata %}
                <div id="iso19115-metadata" class="tab-pane fade" role="tabpanel">
                    <pre class="m-3">
                        {{- iso19115_metadata|format_json -}}
                    </pre>
                </div>
            {% endif %}
        </div>
    </main>
{% endblock %}
