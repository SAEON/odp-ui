{% extends 'base.html' %}
{% from 'content.j2' import render_info %}

{% set metadata = record | select_datacite_metadata %}

{% block web_title %}
    {{ super() }} |
    {% block heading %}
        {{ metadata.titles[0].title }}
    {% endblock %}
{% endblock %}

{% block main %}
    <main class="d-flex flex-grow-1 align-items-center justify-content-evenly">
        <div class="container-md">
            <ul class="nav nav-tabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#info" type="button" role="tab">
                        Digital Object Record
                    </button>
                </li>
            </ul>
            <div class="tab-content">
                <div id="info" class="tab-pane fade show active" role="tabpanel">
                    {% call(prop) render_info(record,
                        'Title',
                        'Authors',
                        'Contributors',
                        'Abstract',
                        'Methods',
                        'Temporal extent',
                        'Spatial extent',
                        'Publisher',
                        'DOI',
                        'Keywords',
                        'License',
                        'Data',
                        hide_id=True
                    ) %}
                        {% if prop == 'Title' %}
                            <strong>{{ metadata.titles[0].title }}</strong>

                        {% elif prop == 'Authors' %}
                            {% for creator in metadata.creators %}
                                <p>{{ creator.name }}<br/>
                                    <small>{{ creator.affiliation | map(attribute='affiliation') | join('<br/>') }}</small>
                                </p>
                            {% endfor %}

                        {% elif prop == 'Contributors' %}
                            {% for contributor in metadata.contributors %}
                                <p>{{ contributor.contributorType | datacite_enum }}: {{ contributor.name }}<br/>
                                    <small>{{ contributor.affiliation | map(attribute='affiliation') | join('<br/>') }}</small>
                                </p>
                            {% endfor %}

                        {% elif prop == 'Abstract' %}
                            {{ metadata.descriptions | selectattr('descriptionType', '==', 'Abstract') | map(attribute='description') | first }}

                        {% elif prop == 'Methods' %}
                            {{ metadata.descriptions | selectattr('descriptionType', '==', 'Methods') | map(attribute='description') | first }}

                        {% elif prop == 'Temporal extent' %}
                            {% if record.temporal_start %}
                                {{ record.temporal_start | date }}
                                {% if record.temporal_end %}
                                    &ndash; {{ record.temporal_end | date }}
                                {% endif %}
                            {% endif %}

                        {% elif prop == 'Spatial extent' %}
                            <div id="map"></div>

                        {% elif prop == 'Publisher' %}
                            {{ metadata.publisher }} ({{ metadata.publicationYear }})

                        {% elif prop == 'DOI' %}
                            {{ record.doi if record.doi }}

                        {% elif prop == 'Keywords' %}
                            {{ metadata.subjects | map(attribute='subject') | join(', ') }}

                        {% elif prop == 'License' %}
                            <a href="{{ metadata.rightsList[0].rightsURI }}" target="_blank">
                                {{ metadata.rightsList[0].rights }}
                            </a>

                        {% elif prop == 'Data' %}
                            {% if metadata.immutableResource %}
                                <a href="{{ metadata.immutableResource.resourceDownload.downloadURL }}" class="btn btn-primary">
                                    Download
                                </a>
                            {% else %}
                                n/a
                            {% endif %}

                        {% endif %}
                    {% endcall %}
                </div>
            </div>
        </div>
    </main>
{% endblock %}

{% block scripts %}
    {{ super() }}

    {% set N, E, S, W = record.spatial_north, record.spatial_east, record.spatial_south, record.spatial_west %}
    {% if N is not none and E is not none and S is not none and W is not none %}
        <script>
            createExtentMap({{ N }}, {{ E }}, {{ S }}, {{ W }});
        </script>
    {% endif %}
{% endblock %}
